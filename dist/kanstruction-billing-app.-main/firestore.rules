
/**
 * @fileoverview Firestore Security Rules for SwiftBill App
 *
 * Core Philosophy:
 * This ruleset enforces a strict data model with public read access to product information
 * and user-ownership for invoices and invoice items.
 *
 * Data Structure:
 * - /product_categories/{productCategoryId}: Stores product categories, publicly readable.
 * - /products/{productId}: Stores product, publicly readable.
 * - /users/{userId}/invoices/{invoiceId}: Stores invoices, accessible only by the owner (the user whose ID is {userId}).
 * - /users/{userId}/invoices/{invoiceId}/invoice_items/{invoiceItemId}: Stores invoice items, accessible only by the owner.
 *
 * Key Security Decisions:
 * - Product categories and products are publicly readable but not writable via the client.
 * - Users can only create, read, update, and delete their own invoices and invoice items.
 * - Listing product data is public.
 * - Listing invoice data is restricted to the owner.
 *
 * Denormalization for Authorization:
 * Not applicable in this version. If shared invoices or user roles were added, it would be
 * necessary to denormalize membership information directly into the shared document to avoid
 * costly `get()` calls in the security rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to product categories, but restricts writes.
     * @path /product_categories/{productCategoryId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Public read, no client writes
     */
    match /product_categories/{productCategoryId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to products, but restricts writes.
     * @path /products/{productId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Public read, no client writes
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Enforces user-ownership for invoices. Only the user whose ID matches {userId} can
     *              create, read, update, or delete invoices under their user path.
     * @path /users/{userId}/invoices/{invoiceId}
     * @allow create: if isSignedIn() && isOwner(userId);
     * @allow get, list: if isSignedIn() && isOwner(userId);
     * @allow update: if isSignedIn() && isExistingOwner(userId);
     * @allow delete: if isSignedIn() && isExistingOwner(userId);
     * @deny create: if isSignedIn() && userId != request.auth.uid;
     * @deny get, list: if !isSignedIn();
     * @deny update: if !isSignedIn();
     * @deny delete: if !isSignedIn();
     * @principle Enforces document ownership for writes, and authenticated access for reads.
     */
    match /users/{userId}/invoices/{invoiceId} {
      allow create: if isSignedIn() && isOwner(userId);
      allow get, list: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for invoice items. Only the user whose ID matches {userId} can
     *              create, read, update, or delete invoice items under their user/invoice path.
     * @path /users/{userId}/invoices/{invoiceId}/invoice_items/{invoiceItemId}
     * @allow create: if isSignedIn() && isOwner(userId);
      * @allow get, list: if isSignedIn() && isOwner(userId);
     * @allow update: if isSignedIn() && isExistingOwner(userId);
     * @allow delete: if isSignedIn() && isExistingOwner(userId);
     * @deny create: if isSignedIn() && userId != request.auth.uid;
     * @deny get, list: if !isSignedIn();
     * @deny update: if !isSignedIn();
     * @deny delete: if !isSignedIn();
     * @principle Enforces document ownership for writes, and authenticated access for reads.
     */
    match /users/{userId}/invoices/{invoiceId}/invoice_items/{invoiceItemId} {
      allow create: if isSignedIn() && isOwner(userId);
      allow get, list: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    // --- Helper functions ---

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user ID matches the authenticated user's ID.
     * @param {string} userId The user ID to check.
     * @return {boolean} True if the user ID matches the authenticated user's ID, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && userId == request.auth.uid;
    }

    /**
     * @description Combines ownership check with resource existence check.
     * @param {string} userId The user ID to check.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}
